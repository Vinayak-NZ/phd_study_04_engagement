table(data_imputed_long$ux)
table(data_imputed_long$ux, data_imputed_long$co_creation_method)
prop.table(table(data_imputed_long$ux, data_imputed_long$co_creation_method))
prop.table(table(data_imputed_long$ux, data_imputed_long$co_creation_method), 2)
prop.table(table(data_imputed_long$utility, data_imputed_long$co_creation_method), 2)
prop.table(table(data_imputed_long$content, data_imputed_long$co_creation_method), 2)
data_imputed_output <- list()
for (i in 1:data_imputed$m){
data_imputed_output[[i]] <- complete(data_imputed, i)
}
for (i in 1:length(data_imputed_output)){
data_imputed_output[[i]] <-
distinct(data_imputed_output[[i]], version, id, .keep_all = TRUE)
data_imputed_output[[i]]$progress_score <-
(data_imputed_output[[i]]$lessons_viewed*10)*0.5 +
(data_imputed_output[[i]]$proportion_pages_viewed*0.3) +
(data_imputed_output[[i]]$proportion_items_completed*0.2)
data_imputed_output[[i]]$comm_mean_pre <- rowMeans(
data_imputed_output[[i]][, paste0("comm", 1:7, "_t1")],
na.rm = TRUE
)
data_imputed_output[[i]]$comm_mean_post <- rowMeans(
data_imputed_output[[i]][, paste0("comm", 1:7, "_t4")],
na.rm = TRUE
)
data_imputed_output[[i]]$safe_mean_pre <- rowMeans(
data_imputed_output[[i]][, paste0("safe", 1:2, "_t1")],
na.rm = TRUE
)
data_imputed_output[[i]]$safe_mean_post <- rowMeans(
data_imputed_output[[i]][, paste0("safe", 1:2, "_t2")],
na.rm = TRUE
)
setDT(data_imputed_output[[i]])
data_imputed_output[[i]] <- melt(data_imputed_output[[i]],
id.vars = c("id",
"version",
"UserCode",
"age",
"education",
"fam_comp",
"in_app_age_grp",
"in_app_occupation",
"item_response",
"total_log_in",
"progress_score",
"average_time_spent",
"days_between",
"proportion_pages_viewed",
"lessons_viewed",
"proportion_items_completed",
"action_plan",
"hapa1_t1",
"hapa2_t1",
"hapa3_t1",
"hapa4_t1",
"hapa5_t1",
"ux",
"content",
"utility"),
measure.vars = list(c("comm_mean_pre", "comm_mean_post"),
c("safe_mean_pre", "safe_mean_post")),
variable.name = "time",
value.name = c("comm_mean",
"safe_mean"))
data_imputed_output[[i]]$time <-
factor(data_imputed_output[[i]]$time,
order = FALSE,
levels = c(1, 2))
data_imputed_output[[i]]$progress_score_scaled <-
scale(data_imputed_output[[i]]$progress_score)[,1]
data_imputed_output[[i]]$action_plan <-
as.factor(data_imputed_output[[i]]$action_plan)
data_imputed_output[[i]]$comm_mean_scaled <-
scale(data_imputed_output[[i]]$comm_mean)[,1]
data_imputed_output[[i]]$safe_mean_scaled <-
scale(data_imputed_output[[i]]$safe_mean)[,1]
data_imputed_output[[i]]$co_creation_method <-
as.factor(ifelse(data_imputed_output[[i]]$version == "Version 1", 0, 1))
data_imputed_output[[i]]$average_time_spent <-
as.numeric(data_imputed_output[[i]]$average_time_spent)
data_imputed_output[[i]]$days_between <-
as.numeric(data_imputed_output[[i]]$days_between)
data_imputed_output[[i]]$average_time_spent_scaled <-
scale(data_imputed_output[[i]]$average_time_spent)[,1]
data_imputed_output[[i]] <- as.data.frame(data_imputed_output[[i]])
data_imputed_output[[i]]$.id <- data_imputed_output[[i]]$id
data_imputed_output[[i]]$.imp <- i
data_imputed_output[[i]] <-
data_imputed_output[[i]][, c(".imp",
".id",
"id",
"co_creation_method",
"UserCode",
"age",
"education",
"fam_comp",
"in_app_age_grp",
"in_app_occupation",
"item_response",
"total_log_in",
"progress_score",
"progress_score_scaled",
"average_time_spent_scaled",
"days_between",
"proportion_pages_viewed",
"lessons_viewed",
"proportion_items_completed",
"action_plan",
"ux",
"content",
"utility",
"time",
"hapa1_t1",
"hapa2_t1",
"hapa3_t1",
"hapa4_t1",
"hapa5_t1",
"safe_mean",
"comm_mean",
"safe_mean_scaled",
"comm_mean_scaled")]
}
data_imputed_long <- do.call(rbind, data_imputed_output)
priors_progress <-
set_prior(sprintf("normal(%f, %f)", prior_progress_pe, prior_progress_sd),
class = "b", coef = "co_creation_method1")
priors_action_plan <-
set_prior(sprintf("normal(%f, %f)", prior_action_plan_pe, prior_action_plan_sd),
class = "b", coef = "co_creation_method1")
priors_time_spent <-
set_prior(sprintf("normal(%f, %f)", prior_time_spent_pe, prior_time_spent_sd),
class = "b", coef = "co_creation_method1")
priors_comms <-
set_prior(sprintf("normal(%f, %f)", prior_comms_pe, prior_comms_sd),
class = "b", coef = "co_creation_method1:time2")
priors_safe <-
set_prior(sprintf("normal(%f, %f)", prior_safety_pe, prior_safety_sd),
class = "b", coef = "co_creation_method1:time2")
priors_outcomes <- c(priors_comms, priors_safe)
bf_freq <- bf(
total_log_in ~ co_creation_method + hapa1_t1 + hapa2_t1 + hapa3_t1 + hapa4_t1 + hapa5_t1,
family = negbinomial()
)
bf_prog <- bf(
progress_score_scaled ~ co_creation_method + hapa1_t1 + hapa2_t1 + hapa3_t1 + hapa4_t1 + hapa5_t1,
family = student()
)
bf_act <- bf(
action_plan ~ co_creation_method + hapa1_t1 + hapa2_t1 + hapa3_t1 + hapa4_t1 + hapa5_t1,
family = bernoulli(link = "logit")
)
bf_time_spent <- bf(
average_time_spent_scaled ~ co_creation_method + hapa1_t1 + hapa2_t1 + hapa3_t1 + hapa4_t1 + hapa5_t1,
family = student()
)
bf_days_between <- bf(
days_between ~ co_creation_method + hapa1_t1 + hapa2_t1 + hapa3_t1 + hapa4_t1 + hapa5_t1,
family = negbinomial()
)
bf_comm <- bf(
comm_mean_scaled ~ co_creation_method * time + hapa1_t1 + hapa2_t1 + hapa3_t1 + hapa4_t1 + hapa5_t1 + (1 | id),
family = gaussian()
)
bf_safe <- bf(
safe_mean_scaled ~ co_creation_method * time + hapa1_t1 + hapa2_t1 + hapa3_t1 + hapa4_t1 + hapa5_t1 + (1 | id),
family = gaussian()
)
model_freq <- brm(
bf_freq,
data = data_imputed_long,
seed = 555,
chains = 4,
cores = 4,
iter = 4000,
warmup = 500,
backend = "cmdstanr",
control = list(adapt_delta = 0.95, max_treedepth = 15))
names(which(colSums(is.na(data_imputed_long)) > 0))
summary(data_imputed_long$hapa1_t1)
length(data_imputed_output)
summary(data_imputed_output[[1]]$hapa1_t1)
data_imputed$method
pred <- data_imputed$predictorMatrix
pred[rowSums(pred) == 0, ]   #
data_imputed$loggedEvents
## ---- prep-data
source("R/00_load_data.R")
source("R/00_load_functions.R")
source("R/00_load_package.R")
source("R/01_format_active_data.R")
source("R/01_format_passive_data.R")
source("R/02_format_active_data_feedback.R")
source("R/02_format_active_data_hapa.R")
source("R/02_format_active_data_outcomes.R")
source("R/02_format_app_v2_baseline.R")
source("R/02_format_baseline_all.R")
source("R/02_format_demographics_in_app.R")
source("R/02_join_data.R")
source("R/03_prepare_data.R")
source("R/04_derive_variables.R")
source("R/04_process_app_use_data.R")
pred <- data_imputed$predictorMatrix
pred[rowSums(pred) == 0, ]
pred
unique_cases <-
distinct(final_data_all_vars, version, id, .keep_all = TRUE)
unique_cases <-
as.data.frame(unique_cases)
# variables-impute
vars_impute <- c(
"hapa1_t1","hapa1_t2","hapa1_t3","hapa1_t4",
"hapa2_t1","hapa2_t2","hapa2_t3","hapa2_t4",
"hapa3_t1","hapa3_t2","hapa3_t3","hapa3_t4",
"hapa4_t1","hapa4_t2","hapa4_t3","hapa4_t4",
"hapa5_t1","hapa5_t2","hapa5_t3","hapa5_t4",
"safe1_t1","safe2_t1","safe1_t2","safe2_t2",
"comm1_t1","comm1_t2","comm1_t3","comm1_t4",
"comm2_t1","comm2_t2","comm2_t3","comm2_t4",
"comm3_t1","comm3_t2","comm3_t3","comm3_t4",
"comm4_t1","comm4_t2","comm4_t3","comm4_t4",
"comm5_t1","comm5_t2","comm5_t3","comm5_t4",
"comm6_t1","comm6_t2","comm6_t3","comm6_t4",
"comm7_t1","comm7_t2","comm7_t3","comm7_t4",
"ux",
"content",
"utility"
)
# Variables NOT to impute
no_impute <- c(
"id",
"version",
"UserCode",
"age",
"education",
"fam_comp",
"in_app_age_grp",
"in_app_occupation",
"proportion_pages_viewed",
"lessons_viewed",
"proportion_items_completed",
"action_plan",
"item_response",
"total_log_in",
"average_time_spent",
"days_between"
)
# Initialize MICE setup
pred <- make.predictorMatrix(unique_cases)
meth <- make.method(unique_cases)
# Prevent Timestamp from informing others (but allow others to be imputed)
pred[, c("id", "UserCode", "item_response")] <- 0
pred[c("id", "UserCode", "item_response"), ]   <- 0
meth[c("id", "UserCode", "item_response")] <- ""
# Prevent imputation for given variables
meth[no_impute] <- ""
pred[no_impute, ] <- 0
pred[, no_impute] <- 1
pred
unique_cases <-
distinct(final_data_all_vars, version, id, .keep_all = TRUE)
unique_cases <-
as.data.frame(unique_cases)
# variables-impute
vars_impute <- c(
"hapa1_t1","hapa1_t2","hapa1_t3","hapa1_t4",
"hapa2_t1","hapa2_t2","hapa2_t3","hapa2_t4",
"hapa3_t1","hapa3_t2","hapa3_t3","hapa3_t4",
"hapa4_t1","hapa4_t2","hapa4_t3","hapa4_t4",
"hapa5_t1","hapa5_t2","hapa5_t3","hapa5_t4",
"safe1_t1","safe2_t1","safe1_t2","safe2_t2",
"comm1_t1","comm1_t2","comm1_t3","comm1_t4",
"comm2_t1","comm2_t2","comm2_t3","comm2_t4",
"comm3_t1","comm3_t2","comm3_t3","comm3_t4",
"comm4_t1","comm4_t2","comm4_t3","comm4_t4",
"comm5_t1","comm5_t2","comm5_t3","comm5_t4",
"comm6_t1","comm6_t2","comm6_t3","comm6_t4",
"comm7_t1","comm7_t2","comm7_t3","comm7_t4",
"ux",
"content",
"utility"
)
# Variables NOT to impute
no_impute <- c(
"id",
"version",
"UserCode",
"age",
"education",
"fam_comp",
"in_app_age_grp",
"in_app_occupation",
"proportion_pages_viewed",
"lessons_viewed",
"proportion_items_completed",
"action_plan",
"item_response",
"total_log_in",
"average_time_spent",
"days_between"
)
# Initialize MICE setup
pred <- make.predictorMatrix(unique_cases)
meth <- make.method(unique_cases)
# Prevent Timestamp from informing others (but allow others to be imputed)
meth[names(meth) %in% no_impute] <- ""
pred[, colnames(pred) %in% no_impute] <- 0
# Prevent imputation for given variables
meth[!names(meth) %in% no_impute] <- ""
# Run imputation
data_imputed <- mice(
unique_cases,
m = 5,
maxit = 30,
seed = 555,
predictorMatrix = pred,
method = meth
)
unique_cases <-
distinct(final_data_all_vars, version, id, .keep_all = TRUE)
unique_cases <-
as.data.frame(unique_cases)
# variables-impute
vars_impute <- c(
"hapa1_t1","hapa1_t2","hapa1_t3","hapa1_t4",
"hapa2_t1","hapa2_t2","hapa2_t3","hapa2_t4",
"hapa3_t1","hapa3_t2","hapa3_t3","hapa3_t4",
"hapa4_t1","hapa4_t2","hapa4_t3","hapa4_t4",
"hapa5_t1","hapa5_t2","hapa5_t3","hapa5_t4",
"safe1_t1","safe2_t1","safe1_t2","safe2_t2",
"comm1_t1","comm1_t2","comm1_t3","comm1_t4",
"comm2_t1","comm2_t2","comm2_t3","comm2_t4",
"comm3_t1","comm3_t2","comm3_t3","comm3_t4",
"comm4_t1","comm4_t2","comm4_t3","comm4_t4",
"comm5_t1","comm5_t2","comm5_t3","comm5_t4",
"comm6_t1","comm6_t2","comm6_t3","comm6_t4",
"comm7_t1","comm7_t2","comm7_t3","comm7_t4",
"ux",
"content",
"utility"
)
# Variables NOT to impute
no_impute <- c(
"id",
"version",
"UserCode",
"age",
"education",
"fam_comp",
"in_app_age_grp",
"in_app_occupation",
"proportion_pages_viewed",
"lessons_viewed",
"proportion_items_completed",
"action_plan",
"item_response",
"total_log_in",
"average_time_spent",
"days_between"
)
# Initialize MICE setup
pred <- make.predictorMatrix(unique_cases)
meth <- make.method(unique_cases)
# Prevent Timestamp from informing others (but allow others to be imputed)
meth[names(meth) %in% no_impute] <- ""
pred[, colnames(pred) %in% no_impute] <- 0
# Prevent imputation for given variables
meth[!names(vars_impute) %in% no_impute] <- ""
# Run imputation
data_imputed <- mice(
unique_cases,
m = 5,
maxit = 30,
seed = 555,
predictorMatrix = pred,
method = meth
)
data_imputed_output <- list()
for (i in 1:data_imputed$m){
data_imputed_output[[i]] <- complete(data_imputed, i)
}
summary(data_imputed[[1]]$hapa1_t1)
nrow(data_imputed[[1]])
View(data_imputed_output)
View(data_imputed)
data_imputed[["m"]]
View(data_imputed_output[[1]])
test <- data_imputed_output[[1]][is.na(data_imputed_output[[1]]$hapa1_t1)]
test <- data_imputed_output[[1]][is.na(data_imputed_output[[1]]$hapa1_t1), ]
summary(data_imputed_output[[1]]$hapa1_t1)
source("R/05_post_impute_edits.R")
source("R/04_process_sentiment_data.R")
## ---- derive-priors-sentiment
app_all_sentiment_input <- setDT(app_all_sentiment)
app_all_sentiment_input <-
app_all_sentiment_input[, proportion:=NULL]
app_all_sentiment_input <- dcast(app_all_sentiment_input,
version ~ sentiment,
value.var = "count")
app_all_sentiment_input[["other"]] <-
app_all_sentiment_input[["neutral"]] +  app_all_sentiment_input[["negative"]]
app_all_sentiment_input[["delta"]] <-
app_all_sentiment_input[["positive"]] / app_all_sentiment_input[["other"]]
sentiment_delta_log <-
as.numeric(
log(app_all_sentiment_input[version == "2.0", "delta"] /
app_all_sentiment_input[version == "1.0", "delta"]))
sentiment_se <-
as.numeric(sqrt(1/app_all_sentiment_input[version == "1.0", "positive"] +
1/app_all_sentiment_input[version == "1.0", "other"] +
1/app_all_sentiment_input[version == "2.0", "positive"] +
1/app_all_sentiment_input[version == "2.0", "other"]))
## ---- set-priors-progress
prior_progress_weight <- 0.5
base_sd_progress <- 0.5
smd <- or2smd(sentiment_delta_log, sentiment_se)
prior_progress_pe <- smd$TE
prior_progress_sd <- smd$seTE
## ---- set-priors-action-plan
odds_ratio_action_plan <- exp(sentiment_delta_log)
percent_change_action_plan <- (odds_ratio_action_plan - 1) * 100
prior_action_plan_weight <- 0.5
base_sd_action_plan <- 0.5
prior_action_plan_pe <- sentiment_delta_log * prior_action_plan_weight
prior_action_plan_sd   <-
sqrt((sentiment_se^2 / prior_action_plan_weight) + base_sd_action_plan^2)
## ---- set-priors-time-spent
prior_time_spent_weight <- 0.5
base_sd_time_spent <- 0.5
prior_time_spent_pe <- smd$TE
prior_time_spent_sd <- smd$seTE
## ---- set-priors-comms
prior_comms_weight <- 0.5
base_sd_comms <- 0.5
prior_comms_pe <- smd$TE * prior_comms_weight
prior_comms_sd <- smd$seTE + base_sd_comms
## ---- set-priors-safety
prior_safety_weight <- 0.5
base_sd_safety <- 0.5
prior_safety_pe <- smd$TE * prior_safety_weight
prior_safety_sd <- smd$seTE + base_sd_safety
data_imputed_long <- do.call(rbind, data_imputed_output)
priors_progress <-
set_prior(sprintf("normal(%f, %f)", prior_progress_pe, prior_progress_sd),
class = "b", coef = "co_creation_method1")
priors_action_plan <-
set_prior(sprintf("normal(%f, %f)", prior_action_plan_pe, prior_action_plan_sd),
class = "b", coef = "co_creation_method1")
priors_time_spent <-
set_prior(sprintf("normal(%f, %f)", prior_time_spent_pe, prior_time_spent_sd),
class = "b", coef = "co_creation_method1")
priors_comms <-
set_prior(sprintf("normal(%f, %f)", prior_comms_pe, prior_comms_sd),
class = "b", coef = "co_creation_method1:time2")
priors_safe <-
set_prior(sprintf("normal(%f, %f)", prior_safety_pe, prior_safety_sd),
class = "b", coef = "co_creation_method1:time2")
priors_outcomes <- c(priors_comms, priors_safe)
bf_freq <- bf(
total_log_in ~ co_creation_method + hapa1_t1 + hapa2_t1 + hapa3_t1 + hapa4_t1 + hapa5_t1,
family = negbinomial()
)
bf_prog <- bf(
progress_score_scaled ~ co_creation_method + hapa1_t1 + hapa2_t1 + hapa3_t1 + hapa4_t1 + hapa5_t1,
family = student()
)
bf_act <- bf(
action_plan ~ co_creation_method + hapa1_t1 + hapa2_t1 + hapa3_t1 + hapa4_t1 + hapa5_t1,
family = bernoulli(link = "logit")
)
bf_time_spent <- bf(
average_time_spent_scaled ~ co_creation_method + hapa1_t1 + hapa2_t1 + hapa3_t1 + hapa4_t1 + hapa5_t1,
family = student()
)
bf_days_between <- bf(
days_between ~ co_creation_method + hapa1_t1 + hapa2_t1 + hapa3_t1 + hapa4_t1 + hapa5_t1,
family = negbinomial()
)
bf_comm <- bf(
comm_mean_scaled ~ co_creation_method * time + hapa1_t1 + hapa2_t1 + hapa3_t1 + hapa4_t1 + hapa5_t1 + (1 | id),
family = gaussian()
)
bf_safe <- bf(
safe_mean_scaled ~ co_creation_method * time + hapa1_t1 + hapa2_t1 + hapa3_t1 + hapa4_t1 + hapa5_t1 + (1 | id),
family = gaussian()
)
model_comm <- brm(
bf_comm,
data = data_imputed_long,
prior = priors_comms,
seed = 555,
chains = 4,
cores = 4,
iter = 4000,
warmup = 500,
backend = "cmdstanr",
control = list(adapt_delta = 0.95, max_treedepth = 15))
summary(model_comm)
summary(data_imputed_long$hapa1_t1)
class(data_imputed_long$hapa1_t1)
hist(data_imputed_long$hapa1_t1)
model_freq <- brm(
bf_freq,
data = data_imputed_long,
seed = 555,
chains = 4,
cores = 4,
iter = 4000,
warmup = 500,
backend = "cmdstanr",
control = list(adapt_delta = 0.95, max_treedepth = 15))
summary(model_freq)
